#!/bin/sh
#
#

CRUCIBLE_ENV="${CRUCIBLE_ENV:-development}"

#
# deploy
#
if [ "${CRUCIBLE_ENV}" == "development" ]; then
  # compile the solidity code
  truffle compile --network ${CRUCIBLE_ENV}

  # if this is the dev env, then startup a mock blockchain
  ./scripts/devchain

  # migrate contracts to the appropriate network
  truffle migrate --network ${CRUCIBLE_ENV}
else
  # if this is the staging env, then unseal the vault
  ./scripts/vault_unseal.js

  # Use the following command to create the contract for the first time.
  # Make sure you run ./env-staging or ./env-production first.  You should
  # then set FOUNDRY_PROXY to the address from 'zos create'.
  # zos add Foundry
  # zos push --network staging
  # zos create Foundry --init initialize \
  #   --args "0x7af77b0d604D13a41e6d0f2175D8a61d5f1115C9" --network staging
  #

  OLD_VERSION=`egrep '^  "version":' ./zos.${CRUCIBLE_ENV}.json | awk -F' ' '{ print $2 }' | sed -E 's/",?//g'`
  NEW_VERSION=`egrep '^  "version":' ./zos.json | awk -F' ' '{ print $2 }' | sed -E 's/",?//g'`

  # this will push and update our contracts in staging or prod
  if [ "${OLD_VERSION}" != "${NEW_VERSION}" ]; then
    echo "version changed, updating contracts on chain..."
    zos push --network ${CRUCIBLE_ENV}
    zos update Foundry --network ${CRUCIBLE_ENV}
    # TODO(godsflaw): commit updates to zos.ENVIRONMENT.json
  fi
fi

#
# run tests
#
if [ "${CRUCIBLE_ENV}" == "development" ]; then
  if [ "$#" -eq 0 ]; then
    CRUCIBLE_ARGS="./test/unit/*/*.js"
  else
    CRUCIBLE_ARGS="$@"
  fi

  truffle test --network ${CRUCIBLE_ENV} ${CRUCIBLE_ARGS} && \
    pkill -f ganache-cli
elif [ "${CRUCIBLE_ENV}" == "staging" ]; then
  if [ "$#" -eq 0 ]; then
    CRUCIBLE_ARGS="./test/integration/*/*.js"
  else
    CRUCIBLE_ARGS="$@"
  fi

  truffle test --network ${CRUCIBLE_ENV} ${CRUCIBLE_ARGS}
elif [ "${CRUCIBLE_ENV}" == "production" ]; then
  if [ "$#" -eq 0 ]; then
    CRUCIBLE_ARGS="./test/production/*/*.js"
  else
    CRUCIBLE_ARGS="$@"
  fi

  truffle test --network ${CRUCIBLE_ENV} ${CRUCIBLE_ARGS}
fi

